# Phase 04 - GitHub Integration

**Date:** 2025-11-21
**Priority:** P0 (Critical)
**Implementation Status:** Pending
**Review Status:** Not Started

## Context Links

- **Parent Plan:** [plan.md](./plan.md)
- **Dependencies:**
  - [Phase 03 - Git Operations Service](./phase-03-git-operations-service.md)
- **Related Research:** [Git & GitHub API](./research/researcher-02-git-github-api.md)

## Overview

Automate PR creation via GitHub REST API using fine-grained PATs. After agent pushes code, automatically create PR with conventional commit titles, task descriptions, and bot attribution.

**Key Features:**
- Auto-generate PR titles from commit messages
- Include task description in PR body
- Set base branch (main) and head branch (task-{id})
- Bot attribution in PR metadata
- Handle PR creation errors (branch already has PR, validation failures)

## Key Insights

From research:
- Use Octokit Core (lightweight, 5k/hr rate limit with PATs)
- Fine-grained PATs require "Pull requests: write" permission
- PR creation: `POST /repos/{owner}/{repo}/pulls`
- Response codes: 201 (success), 422 (validation), 403 (permissions), 404 (repo not found)
- GitHub Apps provide 15k/hr rate limits (consider for production)

## Requirements

### Functional
- Create PR from task branch to main
- Auto-generate PR title from latest commit message
- Format PR body with task details and checklist
- Store PR URL in task database record
- Handle duplicate PR errors gracefully
- Validate permissions before PR creation
- Support private repositories

### Non-Functional
- PR creation <3 seconds
- Rate limit awareness (5k/hr with PAT)
- Retry on transient API failures
- Structured error messages
- Idempotent operations (don't create duplicate PRs)

## Architecture

### PR Creation Flow

```
Task Complete â†’ Push Branch â†’ Create PR â†’ Update Task â†’ Notify Frontend
                   â†“             â†“           â†“            â†“
              (Phase 03)    GitHub API   Store URL    SSE Event
                                                      (Phase 05)
```

### GitHub API Client

```python
# Use requests library (already in FastAPI)
import requests

class GitHubService:
    def __init__(self, token: str):
        self.token = token
        self.base_url = "https://api.github.com"
        self.headers = {
            "Authorization": f"Bearer {token}",
            "Accept": "application/vnd.github+json",
            "X-GitHub-Api-Version": "2022-11-28"
        }

    async def create_pull_request(
        owner: str,
        repo: str,
        title: str,
        body: str,
        head: str,
        base: str = "main"
    ) -> PRResponse

    async def get_pull_request(owner, repo, pr_number) -> PRResponse
    async def check_existing_pr(owner, repo, head) -> Optional[PRResponse]
```

### PR Template

```markdown
## Summary
Automated changes by Agent {agent_name} for task: {task_title}

## Description
{task_description}

## Changes
- [List auto-generated from commit messages]

## Checklist
- [x] Code implemented
- [x] Conventional commits followed
- [ ] Manual review required
- [ ] Tests passing (if applicable)

---
*ðŸ¤– Auto-generated by Agent Squad*
*Agent: {agent_name} | Task ID: {task_id} | Created: {timestamp}*
```

## Related Code Files

### New Files to Create
- `backend/app/services/github_service.py` - GitHub API client
- `backend/app/api/v1/github.py` - GitHub API endpoints
- `backend/app/schemas/github.py` - PR schemas (PRCreate, PRResponse)
- `backend/app/utils/pr_template.py` - PR body generator
- `backend/tests/test_github_service.py`

### Files to Modify
- `backend/requirements.txt` - Add `httpx` or use existing `requests`
- `backend/app/config.py` - Add GITHUB_REPO_OWNER, GITHUB_REPO_NAME
- `backend/app/api/v1/router.py` - Mount github router
- `backend/app/models/task.py` - Ensure pull_request_url field exists

## Implementation Steps

1. **Update Configuration**
   - Add GITHUB_REPO_OWNER (e.g., "acme-org")
   - Add GITHUB_REPO_NAME (e.g., "main-app")
   - Add GITHUB_API_BASE_URL (default: "https://api.github.com")
   - Verify GITHUB_TOKEN already in config (from Phase 03)

2. **Create GitHub Service Class**
   - Initialize with token, owner, repo from config
   - Set up headers with Bearer token and API version
   - Implement request wrapper with error handling

3. **Implement Check Existing PR**
   - Query: `GET /repos/{owner}/{repo}/pulls?head={owner}:{branch}&state=open`
   - Return existing PR if found (avoid duplicates)
   - Return None if no PR exists

4. **Implement Create PR**
   - Build payload: title, body, head, base
   - POST to `/repos/{owner}/{repo}/pulls`
   - Handle response codes:
     - 201: Success, return PR URL
     - 422: Validation error (branch has no commits, PR already exists)
     - 403: Forbidden (token lacks permissions)
     - 404: Repo not found
   - Parse response JSON for PR number, URL, state

5. **Implement PR Template Generator**
   - Create format_pr_body function
   - Include task title, description
   - List commits from git history
   - Add checklist with bot attribution
   - Add timestamp and agent metadata

6. **Implement Get PR**
   - GET `/repos/{owner}/{repo}/pulls/{pr_number}`
   - Return PR details (state, merged, closed, merged_at)
   - Use for status checking

7. **API Endpoints**
   - POST /api/v1/github/pull-requests - Create PR for task
   - GET /api/v1/github/pull-requests/{pr_number} - Get PR details
   - GET /api/v1/tasks/{task_id}/pull-request - Get PR for task

8. **Workflow Integration**
   - After successful push (Phase 03), trigger PR creation
   - Check for existing PR first (idempotency)
   - Update task.pull_request_url in database
   - Return PR URL to caller

9. **Error Handling**
   - Catch HTTP errors (requests.HTTPError)
   - Parse GitHub error messages from response JSON
   - Return structured errors:
     - PRAlreadyExistsError
     - InsufficientPermissionsError
     - BranchNotFoundError
   - Log errors with context (task_id, branch_name)

10. **Rate Limit Handling**
    - Check rate limit headers in response:
      - `X-RateLimit-Remaining`
      - `X-RateLimit-Reset`
    - Log warnings when <100 requests remaining
    - Implement sleep/retry if rate limited (429 status)

11. **Unit Tests**
    - Mock GitHub API responses
    - Test PR creation success
    - Test duplicate PR detection
    - Test validation errors (422)
    - Test permission errors (403)
    - Test rate limit handling

12. **Documentation**
    - Document GitHub PAT setup (scopes needed)
    - Add PR creation flow to README
    - Include example PR URL format

## Todo List

### P0 - Critical

- [ ] Add GITHUB_REPO_OWNER, GITHUB_REPO_NAME to config.py
- [ ] Create app/services/github_service.py with GitHubService class
- [ ] Implement HTTP client with Bearer token auth
- [ ] Implement check_existing_pr method
- [ ] Implement create_pull_request method
- [ ] Implement error handling for 201, 422, 403, 404 responses
- [ ] Create PR body template generator (format_pr_body)
- [ ] Create POST /api/v1/github/pull-requests endpoint
- [ ] Create GET /api/v1/github/pull-requests/{pr_number} endpoint
- [ ] Update task.pull_request_url after PR creation
- [ ] Test PR creation with real GitHub repo
- [ ] Verify PR appears in GitHub web UI
- [ ] Test duplicate PR detection (idempotency)

### P1 - Important

- [ ] Implement get_pull_request method
- [ ] Add rate limit checking and logging
- [ ] Implement retry logic for transient failures
- [ ] Create unit tests with mocked GitHub API
- [ ] Add PR creation timing metrics
- [ ] Document GitHub PAT setup in README
- [ ] Add PR URL validation (ensure HTTPS GitHub URL)

### P2 - Nice to Have

- [ ] Support custom base branches (not just main)
- [ ] Add PR labels via API (e.g., "automated", "agent-generated")
- [ ] Implement PR update (edit title/body)
- [ ] Add PR status webhook handling
- [ ] Support GitHub Apps authentication (higher rate limits)
- [ ] Add PR merge automation (optional)

## Success Criteria

- [ ] PR created successfully with 201 response
- [ ] PR visible in GitHub web UI with correct title and body
- [ ] PR URL stored in task database record
- [ ] Bot attribution visible in PR metadata
- [ ] Duplicate PRs prevented (check existing first)
- [ ] Permission errors handled gracefully
- [ ] Rate limit warnings logged when close to limit
- [ ] Tests verify PR creation flow end-to-end

## Risk Assessment

**High Risks:**
- GitHub token expiration/revocation
- Rate limit exhaustion (5k/hr)
- Permission errors blocking all PRs
- Network failures during API calls

**Medium Risks:**
- PR title conflicts (same name)
- Branch deleted before PR creation
- Validation errors (no commits on branch)

**Mitigation:**
- Monitor token validity, rotate if needed
- Implement rate limit checking, warn at 10% remaining
- Validate token permissions during startup
- Retry API calls with exponential backoff (3 attempts)
- Generate unique PR titles with timestamps if needed
- Verify branch exists before PR creation
- Ensure at least 1 commit on branch before PR

## Security Considerations

- **Token Storage:** Environment variable only, never commit
- **Token Permissions:** Minimum scope: "Pull requests: write", "Contents: read"
- **API Version Pinning:** Use `X-GitHub-Api-Version: 2022-11-28` header
- **Input Validation:** Sanitize task descriptions before PR body (prevent injection)
- **Rate Limit Monitoring:** Alert on suspicious rate limit consumption
- **Audit Logging:** Log all PR creation attempts with outcomes

## Time Estimates

| Executor | Time | Notes |
|----------|------|-------|
| Claude | 35 min | API client, endpoint generation |
| Senior Dev | 3-4 hrs | GitHub API familiarity, testing |
| Junior Dev | 8-10 hrs | API integration, error handling |

**Complexity:** Medium (HTTP API integration, error handling)

## Next Steps

After completion:
- [Phase 05 - SSE Real-Time Updates](./phase-05-sse-realtime-updates.md) - Broadcast PR creation events
- [Phase 06 - Frontend Integration](./phase-06-frontend-integration.md) - Display PR links in UI

## Unresolved Questions

1. **PR Reviewers:** Auto-assign reviewers? Who?
2. **Draft PRs:** Create as draft initially, mark ready when tests pass?
3. **PR Labels:** Which labels to auto-apply? ("automated", "needs-review", etc.)
4. **Multiple Commits:** Squash or preserve commit history in PR?
5. **Branch Protection:** How to handle protected branches (require reviews)?
6. **Merge Strategy:** Squash, rebase, or merge commit? (GitHub repo settings or API control?)
7. **Notifications:** Suppress GitHub notifications for bot PRs?
